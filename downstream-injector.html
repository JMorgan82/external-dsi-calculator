<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Downstream Injector Dilution Calculator</title>
  <style>
    :root { --bg:#0b0f14; --card:#121824; --text:#e7eefc; --muted:#9ab0d0; --line:#22304a; --accent:#63b3ff; --warn:#ffd18a; }
    *, *::before, *::after { box-sizing: border-box; }

    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:linear-gradient(180deg,#070b10,#0b0f14); color:var(--text); }
    .wrap { max-width: 860px; margin: 0 auto; padding: 28px 16px 60px; }
    h1 { margin: 0 0 8px; font-size: 22px; letter-spacing:.2px; }
    .sub { color:var(--muted); margin:0 0 18px; }

    .nav { display:flex; gap:10px; flex-wrap:wrap; margin: 0 0 14px; }
    .linkbtn { text-decoration:none; border:1px solid #2a3a58; background:#0d1420; color:var(--text); padding: 8px 10px; border-radius: 10px; font-size: 13px; }
    .linkbtn:hover { filter: brightness(1.06); }

    .card { background:var(--card); border:1px solid var(--line); border-radius: 14px; padding: 16px; box-shadow: 0 12px 40px rgba(0,0,0,.35); }
    .grid { display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width:720px){ .grid { grid-template-columns: 1fr 1fr; } }
    .grid > div { min-width:0; }

    label { display:block; font-size: 12px; color:var(--muted); margin:0 0 6px; }
    select, input { width:100%; padding: 11px 12px; border-radius: 10px; border:1px solid var(--line); background:#0d1420; color:var(--text); outline:none; }
    input::placeholder { color:#6f86ad; }

    .row { display:flex; gap: 10px; flex-wrap: wrap; align-items:center; margin-top: 10px; }
    .btn { cursor:pointer; border:1px solid #2a3a58; background:linear-gradient(180deg,#1a3c66,#12304f); color:var(--text); padding: 11px 14px; border-radius: 12px; font-weight: 600; }
    .btn:hover { filter: brightness(1.06); }

    .result { margin-top: 14px; padding: 14px; border-radius: 12px; border:1px dashed #2a3a58; background:#0a111c; }
    .big { font-size: 18px; font-weight: 800; margin: 0 0 6px; }
    .small { margin: 0; color:var(--muted); font-size: 13px; line-height:1.45; }
    .warn { color: var(--warn); }

    .table { margin-top: 12px; border:1px solid var(--line); border-radius: 12px; overflow:hidden; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 10px 10px; border-bottom:1px solid var(--line); text-align:left; font-size: 13px; }
    th { background:#0d1522; color:#b9c9e8; font-weight:700; }
    tr:last-child td { border-bottom:none; }
    .muted { color:var(--muted); }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #2a3a58; color:#b9c9e8; font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Downstream Injector Dilution Calculator</h1>
    <p class="sub">Pick your DS injector type + machine GPM, enter your stock % and desired output %, then get exact batch mix recipes.</p>

    <div class="nav">
      <a class="linkbtn" href="./index.html">External Injector (X-Jet/JOEJET/FIXFANS)</a>
      <a class="linkbtn" href="./downstream-injector.html">Regular Downstream Injector</a>
    </div>

    <div class="card">
      <div class="grid">
        <div>
          <label for="inj">Downstream Injector Type</label>
          <select id="inj"></select>
        </div>

        <div>
          <label for="gpm">Machine Flow (GPM)</label>
          <select id="gpm"></select>
        </div>

        <div>
          <label for="stock">Stock Chemical Strength (%)</label>
          <input id="stock" type="number" step="0.01" min="0" max="100" placeholder="Example: 12.5" value="12.5"/>
        </div>

        <div>
          <label for="desired">Desired Output at Gun (%)</label>
          <input id="desired" type="number" step="0.01" min="0" max="100" placeholder="Example: 1.0" value="1.0"/>
        </div>
      </div>

      <div class="row">
        <button class="btn" id="calc">Calculate</button>
        <span class="pill">Results = bucket/tank dilution recipes</span>
      </div>

      <div class="result" id="result" style="display:none;"></div>
      <div class="table" id="tableWrap" style="display:none;"></div>
    </div>
  </div>
<script>
  /***************************************************
   * INJECTOR LIST (PLACEHOLDER)
   * Replace this list with your exact DS injector list.
   *
   * ratios are Water:Chem = R:1 and can vary by GPM.
   * Example: ratios: { "4": 12 } means at 4 GPM the injector draws ~12:1
   ***************************************************/
  const INJECTORS = [
    {
      id: "general_ds",
      name: "General DS Injector (baseline)",
      ratios: { "2": 16, "3": 14, "4": 12, "5": 12, "6": 12, "7": 12, "8": 12, "9": 12, "10": 12 }
    },
    {
      id: "high_draw",
      name: "High-Draw DS Injector",
      ratios: { "2": 12, "3": 10, "4": 8, "5": 8, "6": 8, "7": 8, "8": 8, "9": 8, "10": 8 }
    },
    {
      id: "low_draw",
      name: "Low-Draw DS Injector (safer/leaner)",
      ratios: { "2": 20, "3": 20, "4": 20, "5": 20, "6": 20, "7": 20, "8": 20, "9": 20, "10": 20 }
    }
  ];

  const BATCH_SIZES_GAL = [1, 5, 10, 15, 20, 30, 55];

  function round(n, d = 2){
    const p = Math.pow(10, d);
    return Math.round(n * p) / p;
  }

  function clamp01(x){ return Math.max(0, Math.min(1, x)); }

  // Output at gun when tank is T% and ratio is R:1
  function outputFromTankMix(tankPct, ratioR){
    return tankPct / (ratioR + 1);
  }

  // Required tank strength to achieve desired output at gun
  function requiredTankMix(desiredPct, ratioR){
    return desiredPct * (ratioR + 1);
  }

  // Batch recipe for volume V gallons:
  // tankMixPct = (chem_gal/V)*stockPct  => chem_gal = V * (tankMixPct/stockPct)
  function batchRecipeGallons(volumeGal, stockPct, requiredTankPct){
    const fracChem = requiredTankPct / stockPct; // fraction of stock chem in tank
    const chemGal = volumeGal * fracChem;
    const waterGal = volumeGal - chemGal;
    return { chemGal, waterGal, fracChem };
  }

  function populateSelects(){
    const injSel = document.getElementById("inj");
    injSel.innerHTML = INJECTORS.map(x => `<option value="${x.id}">${x.name}</option>`).join("");

    const gpmSel = document.getElementById("gpm");
    const gpms = [];
    for (let i=2;i<=10;i++) gpms.push(i);
    gpmSel.innerHTML = gpms.map(g => `<option value="${g}" ${g===4 ? "selected":""}>${g} GPM</option>`).join("");
  }

  function getInjectorById(id){
    return INJECTORS.find(x => x.id === id) || INJECTORS[0];
  }

  function renderBatchTable(rows){
    const header = `
      <table>
        <thead>
          <tr>
            <th>Batch Size</th>
            <th>Stock Chem to Add (gal)</th>
            <th>Water to Add (gal)</th>
          </tr>
        </thead>
        <tbody>
    `;
    const body = rows.map(r => `
      <tr>
        <td><strong>${r.volume} gal</strong></td>
        <td><strong>${round(r.chemGal, 2)}</strong></td>
        <td><strong>${round(r.waterGal, 2)}</strong></td>
      </tr>
    `).join("");
    return header + body + `</tbody></table>`;
  }
  function recommendWhenUnreachable({ stockPct, desiredPct, ratioR }){
    const maxOutputIfStraight = outputFromTankMix(stockPct, ratioR);

    // Non-pushy “what to do” options
    const suggestions = [];

    suggestions.push(`With this injector at ${ratioR}:1, the strongest you can hit using ${stockPct}% stock (straight) is ~${round(maxOutputIfStraight, 3)}%.`);

    suggestions.push(`To reach ${desiredPct}%, you’d need a tank mix of ~${round(requiredTankMix(desiredPct, ratioR), 3)}% (stronger than your stock).`);

    suggestions.push(`Options to reach your goal:`);
    suggestions.push(`• Use a stronger starting chem (higher %), OR`);
    suggestions.push(`• Switch to a higher-draw downstream injector (lower ratio), OR`);
    suggestions.push(`• Use an external injector setup (X-Jet / pump-up / dedicated softwash), OR`);
    suggestions.push(`• Lower desired output to ≤ ~${round(maxOutputIfStraight, 3)}% for this setup.`);

    // “Organic product” suggestion (soft)
    suggestions.push(`If you’re trying to avoid hotter bleach, consider a strong surfactant-based / “organic” cleaner and let dwell time do more work (especially on organics).`);

    return suggestions;
  }

  document.getElementById("calc").addEventListener("click", () => {
    const injId = document.getElementById("inj").value;
    const gpm = String(document.getElementById("gpm").value);
    const stock = Number(document.getElementById("stock").value);
    const desired = Number(document.getElementById("desired").value);

    const resultEl = document.getElementById("result");
    const tableWrap = document.getElementById("tableWrap");

    // Validation
    if (!isFinite(stock) || stock <= 0 || stock > 100) {
      resultEl.style.display = "block";
      tableWrap.style.display = "none";
      resultEl.innerHTML = `<p class="big">Check your stock %</p><p class="small">Enter a valid stock chemical strength between 0 and 100.</p>`;
      return;
    }
    if (!isFinite(desired) || desired <= 0 || desired > 100) {
      resultEl.style.display = "block";
      tableWrap.style.display = "none";
      resultEl.innerHTML = `<p class="big">Check your desired %</p><p class="small">Enter a valid desired output strength between 0 and 100.</p>`;
      return;
    }

    const injector = getInjectorById(injId);

    // If injector has no ratio for that GPM, fall back to nearest available key
    let ratioR = injector.ratios[gpm];
    if (!isFinite(ratioR)) {
      const keys = Object.keys(injector.ratios).map(Number).sort((a,b)=>a-b);
      const target = Number(gpm);
      let bestKey = keys[0];
      let bestDiff = Infinity;
      for (const k of keys) {
        const d = Math.abs(k - target);
        if (d < bestDiff) { bestDiff = d; bestKey = k; }
      }
      ratioR = injector.ratios[String(bestKey)];
    }

    const reqTank = requiredTankMix(desired, ratioR);
    const maxOutputStraight = outputFromTankMix(stock, ratioR);

    // Unreachable if required tank mix is stronger than stock
    const unreachable = reqTank > stock + 1e-12;

    resultEl.style.display = "block";
    tableWrap.style.display = unreachable ? "none" : "block";

    if (unreachable) {
      const lines = recommendWhenUnreachable({ stockPct: stock, desiredPct: desired, ratioR });
      resultEl.innerHTML = `
        <p class="big">Desired output is unreachable</p>
        <p class="small warn" style="margin-bottom:10px;">
          You want <strong>${round(desired,3)}%</strong> at the gun, but with <strong>${round(stock,3)}%</strong> stock and a <strong>${ratioR}:1</strong> injector, the max possible is ~<strong>${round(maxOutputStraight,3)}%</strong>.
        </p>
        <p class="small">${lines.map(x => x).join("<br/>")}</p>
      `;
      return;
    }

    // Build batch recipes
    const batchRows = BATCH_SIZES_GAL.map(v => {
      const { chemGal, waterGal } = batchRecipeGallons(v, stock, reqTank);
      return { volume: v, chemGal, waterGal };
    });

    resultEl.innerHTML = `
      <p class="big">Mix your bucket/tank to: <span style="color:var(--accent)">${round(reqTank,3)}%</span></p>
      <p class="small">
        That will output ~<strong>${round(desired,3)}%</strong> at the gun using <strong>${injector.name}</strong> at <strong>${gpm} GPM</strong> (~<strong>${ratioR}:1</strong>).
      </p>
      <p class="small muted" style="margin-top:8px;">Batch Recipes (Same Setup)</p>
    `;

    tableWrap.innerHTML = renderBatchTable(batchRows);
  });

  // init
  populateSelects();
</script>
</body>
</html>
