<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Downstream Injector Dilution Calculator</title>
  <style>
    :root {
      --bg:#0b0f14; --card:#121824; --text:#e7eefc;
      --muted:#9ab0d0; --line:#22304a;
      --accent:#63b3ff; --warn:#ffd18a;
    }
    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:linear-gradient(180deg,#070b10,#0b0f14);
      color:var(--text);
    }

    .wrap { max-width: 860px; margin: 0 auto; padding: 28px 16px 60px; }
    h1 { margin: 0 0 8px; font-size: 22px; }
    .sub { color:var(--muted); margin:0 0 18px; }

    .nav { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px; }
    .linkbtn {
      text-decoration:none;
      border:1px solid #2a3a58;
      background:#0d1420;
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      font-size:13px;
    }
    .linkbtn:hover { filter: brightness(1.06); }
    .linkbtn.active {
      border-color:#2f5ea0;
      background: linear-gradient(180deg,#1a3c66,#12304f);
    }

    .card {
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:16px;
      box-shadow:0 12px 40px rgba(0,0,0,.35);
    }

    .grid { display:grid; grid-template-columns:1fr; gap:12px; }
    @media (min-width:720px){ .grid{ grid-template-columns:1fr 1fr; } }

    label { font-size:12px; color:var(--muted); }
    select, input {
      width:100%;
      padding:11px 12px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#0d1420;
      color:var(--text);
      outline:none;
    }

    .btn {
      cursor:pointer;
      border:1px solid #2a3a58;
      background:linear-gradient(180deg,#1a3c66,#12304f);
      color:var(--text);
      padding:11px 14px;
      border-radius:12px;
      font-weight:600;
      margin-top:10px;
    }
    .btn:hover { filter: brightness(1.06); }

    .result {
      margin-top:14px;
      padding:14px;
      border-radius:12px;
      border:1px dashed #2a3a58;
      background:#0a111c;
    }

    .big { font-size:18px; font-weight:800; margin:0 0 6px; }
    .small { font-size:13px; color:var(--muted); line-height:1.45; margin:0; }
    .warn { color:var(--warn); }

    .table { margin-top:12px; border:1px solid var(--line); border-radius:12px; overflow:hidden; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px; border-bottom:1px solid var(--line); font-size:13px; text-align:left; }
    th { background:#0d1522; }
    tr:last-child td { border-bottom:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Downstream Injector Dilution Calculator</h1>
    <p class="sub">
      Choose your downstream injector + GPM, enter stock % and desired output %, then get batch mix recipes.
    </p>

    <!-- TOP NAV (only switch) -->
    <div class="nav">
      <a class="linkbtn" href="./index.html">External Injector Calculator</a>
      <a class="linkbtn active" href="./downstream-injector.html" aria-current="page">Regular Downstream Injector</a>
    </div>

    <div class="card">
      <div class="grid">
        <div>
          <label>Downstream Injector Type</label>
          <select id="inj"></select>
        </div>

        <div>
          <label>Machine Flow (GPM)</label>
          <select id="gpm"></select>
        </div>

        <div>
          <label>Stock Chemical Strength (%)</label>
          <input id="stock" type="number" step="0.01" min="0" max="100" value="12.5" />
        </div>

        <div>
          <label>Desired Output at Gun (%)</label>
          <input id="desired" type="number" step="0.01" min="0" max="100" value="1.0" />
        </div>
      </div>

      <button class="btn" id="calc">Calculate</button>

      <div class="result" id="result" style="display:none;"></div>
      <div class="table" id="tableWrap" style="display:none;"></div>

      <p class="small" style="margin-top:12px;">
        <strong>Disclaimer:</strong> Results are estimates. Actual draw varies by hose length, injector condition,
        nozzle choice, temperature, and chemical viscosity. Brand names are used for identification only.
      </p>
    </div>
  </div>

<script>
const DRAW_NOTE =
  "Actual draw varies by hose length, injector condition, nozzle choice, temperature, and chemical viscosity.";

const INJECTORS = [
  { id:"supersuds", name:"Super Suds Sucker (est. 30%)", ratios:{4:2.333,5:2.333,6:2.333,7:2.333,8:2.333,9:2.333,10:2.333}},
  { id:"gp", name:"General Pump High Draw (20%)", ratios:{3:4,4:4,5:4}},
  { id:"o18", name:"Standard DS — Orifice 1.8", ratios:{2:9,3:9,4:9,5:9,6:9,7:9,8:9,9:9,10:9}},
  { id:"o21", name:"Standard DS — Orifice 2.1", ratios:{2:7,3:7,4:7,5:7,6:7,7:7,8:7,9:7,10:7}},
  { id:"o23", name:"Standard DS — Orifice 2.3", ratios:{2:5.667,3:5.667,4:5.667,5:5.667,6:5.667,7:5.667,8:5.667,9:5.667,10:5.667}}
];

const BATCHES = [1,5,10,15,20,30,55];

function round(n,d=2){ return Math.round(n*10**d)/10**d; }

function populate(){
  const injSel = document.getElementById("inj");
  const gpmSel = document.getElementById("gpm");

  injSel.innerHTML = INJECTORS
    .map(i=>`<option value="${i.id}">${i.name}</option>`)
    .join("");

  gpmSel.innerHTML = Array.from({length:9},(_,i)=>i+2)
    .map(g=>`<option value="${g}" ${g===4?"selected":""}>${g}</option>`)
    .join("");
}

function requiredTank(desired, ratio){ return desired*(ratio+1); }

function batch(volume, stock, tank){
  const chem = volume*(tank/stock);
  return { volume, chem, water: volume-chem };
}

// NEW: ratio display helper (Water : Chem) -> "2.7-1 (3-1)"
function ratioDisplay(waterGallons, chemGallons){
  // Safety: avoid divide-by-zero or weird negatives due to rounding
  if (!isFinite(waterGallons) || !isFinite(chemGallons) || chemGallons <= 0) return "—";

  const exact = waterGallons / chemGallons;

  // If exact is extremely large (tiny chem), still show something sane
  if (!isFinite(exact) || exact <= 0) return "—";

  const roundedInt = Math.max(1, Math.round(exact));
  return `${exact.toFixed(1)}-1 (${roundedInt}-1)`;
}

document.getElementById("calc").addEventListener("click", () => {
  const injId = document.getElementById("inj").value;
  const gpmVal = document.getElementById("gpm").value;
  const stockVal = Number(document.getElementById("stock").value);
  const desiredVal = Number(document.getElementById("desired").value);

  const resultEl = document.getElementById("result");
  const tableWrap = document.getElementById("tableWrap");

  const injector = INJECTORS.find(i=>i.id===injId) || INJECTORS[0];
  const r = injector.ratios[gpmVal];

  // Basic input validation
  if (!isFinite(stockVal) || stockVal <= 0 || stockVal > 100) {
    resultEl.style.display = "block";
    tableWrap.style.display = "none";
    resultEl.innerHTML = `<p class="big">Check your stock %</p><p class="small">Enter a valid stock chemical strength between 0 and 100.</p>`;
    return;
  }
  if (!isFinite(desiredVal) || desiredVal <= 0 || desiredVal > 100) {
    resultEl.style.display = "block";
    tableWrap.style.display = "none";
    resultEl.innerHTML = `<p class="big">Check your desired %</p><p class="small">Enter a valid desired output strength between 0 and 100.</p>`;
    return;
  }

  // Unsupported GPM for this injector
  if (!isFinite(r)) {
    resultEl.style.display = "block";
    resultEl.innerHTML = `<p class="big warn">Unsupported GPM</p><p class="small">${DRAW_NOTE}</p>`;
    tableWrap.style.display = "none";
    return;
  }

  const tankPct = requiredTank(desiredVal, r);

  // Unreachable target
  if (tankPct > stockVal + 1e-12) {
    const maxOut = stockVal/(r+1);
    resultEl.style.display = "block";
    resultEl.innerHTML = `
      <p class="big warn">Desired output unreachable</p>
      <p class="small">Max possible (running stock straight) ≈ <strong>${round(maxOut,3)}%</strong></p>
      <p class="small">${DRAW_NOTE}</p>
    `;
    tableWrap.style.display = "none";
    return;
  }

  // Render result
  resultEl.style.display = "block";
  resultEl.innerHTML = `
    <p class="big">Mix your bucket/tank to: <span style="color:var(--accent)">${round(tankPct,3)}%</span></p>
    <p class="small">${injector.name} @ ${gpmVal} GPM</p>
    <p class="small" style="margin-top:6px;">${DRAW_NOTE}</p>
    <p class="small" style="margin-top:10px;">Batch Recipes (Same Setup)</p>
  `;

  // Build table (UPDATED: includes Ratio column)
  tableWrap.style.display = "block";
  tableWrap.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Batch</th>
          <th>Stock Chem (gal)</th>
          <th>Water (gal)</th>
          <th>Ratio</th>
        </tr>
      </thead>
      <tbody>
        ${BATCHES.map(b=>{
          const m = batch(b, stockVal, tankPct);
          const ratioText = ratioDisplay(m.water, m.chem);

          return `
            <tr>
              <td><strong>${b}</strong></td>
              <td><strong>${round(m.chem)}</strong></td>
              <td><strong>${round(m.water)}</strong></td>
              <td><strong>${ratioText}</strong></td>
            </tr>
          `;
        }).join("")}
      </tbody>
    </table>
  `;
});

populate();
</script>
</body>
</html>
